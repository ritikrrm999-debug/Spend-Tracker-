<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Money Spend Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f9; }
    header { background:#4a90e2; color:white; padding:15px; text-align:center; font-size:20px; position:relative; }
    #logout-btn { position:absolute; right:15px; top:15px; background:#e74c3c; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }

    nav { display:flex; justify-content:space-around; background:#333; }
    nav button { flex:1; padding:12px; background:#333; border:none; color:white; cursor:pointer; font-size:16px; }
    nav button.active { background:#4a90e2; }

    section { display:none; padding:20px; }
    section.active { display:block; }

    input, button { padding:8px; margin:5px 0; }
    .list-item { background:white; padding:10px; margin-bottom:8px; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.1); }
    canvas { background:#fff; margin-top:20px; padding:10px; border-radius:6px; }

    /* Edit Modal */
    #edit-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
      background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    #edit-modal .content { background:white; padding:20px; border-radius:8px; width:300px; }
  </style>
</head>
<body>
  <header>
    üí∞ Money Spend Tracker
    <button id="logout-btn">Logout</button>
  </header>

  <nav>
    <button class="tab-btn active" data-tab="home">Home</button>
    <button class="tab-btn" data-tab="spend">Spend</button>
    <button class="tab-btn" data-tab="history">History</button>
    <button class="tab-btn" data-tab="export">Export</button>
  </nav>

  <section id="home" class="active">
    <h2>Check Spending by Date</h2>
    <input type="date" id="homeDate">
    <button onclick="showDaySpend()">Show</button>
    <div id="homeResult"></div>
    <canvas id="weekChart"></canvas>
    <canvas id="monthChart"></canvas>
  </section>

  <section id="spend">
    <h2>Add Spend</h2>
    <input type="date" id="spendDate"><br>
    <input type="text" id="spendItem" placeholder="Item name"><br>
    <input type="number" id="spendPrice" placeholder="Amount"><br>
    <button onclick="addSpend()">Save</button>
  </section>

  <section id="history">
    <h2>Last 5 Purchases</h2>
    <div id="historyList"></div>
  </section>

  <section id="export">
    <h2>Download Data</h2>
    <label>From:</label><br>
    <input type="date" id="fromDate"><br>
    <label>To:</label><br>
    <input type="date" id="toDate"><br>
    <button onclick="downloadExcel()">Download Excel</button>
  </section>

  <!-- Edit Modal -->
  <div id="edit-modal">
    <div class="content">
      <h3>Edit Spend</h3>
      <input type="date" id="edit-date"><br>
      <input type="text" id="edit-item" placeholder="Item"><br>
      <input type="number" id="edit-price" placeholder="Price"><br>
      <button onclick="saveEdit()">Save</button>
      <button onclick="closeEdit()">Cancel</button>
    </div>
  </div>

  <script>
    // üîë Firebase config (replace via GitHub Secrets)
    const firebaseConfig = {
      apiKey: "${FIREBASE_API_KEY}",
      authDomain: "${FIREBASE_AUTH_DOMAIN}",
      projectId: "${FIREBASE_PROJECT_ID}",
      storageBucket: "${FIREBASE_STORAGE_BUCKET}",
      messagingSenderId: "${FIREBASE_MESSAGING_SENDER_ID}",
      appId: "${FIREBASE_APP_ID}"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;
    let editId = null;

    // Auth state check
    auth.onAuthStateChanged(user => {
      if (!user) window.location.href = "index.html";
      else currentUser = user;
    });

    document.getElementById("logout-btn").addEventListener("click", () => auth.signOut());

    // Add Spend
    async function addSpend() {
      if (!currentUser) return;
      const date = document.getElementById("spendDate").value;
      const item = document.getElementById("spendItem").value.trim();
      const price = parseFloat(document.getElementById("spendPrice").value);
      if (!date || !item || isNaN(price)) return alert("Fill all fields");

      await db.collection("users").doc(currentUser.uid).collection("spends").add({
        date, item, price,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("Saved!");
      document.getElementById("spendItem").value = "";
      document.getElementById("spendPrice").value = "";
      loadHistory();
    }

    // Show daily spends
    async function showDaySpend() {
      if (!currentUser) return;
      const date = document.getElementById("homeDate").value;
      const resultDiv = document.getElementById("homeResult");
      resultDiv.innerHTML = "";
      if (!date) return alert("Select a date");

      const snap = await db.collection("users").doc(currentUser.uid).collection("spends")
        .where("date", "==", date).get();

      let total = 0;
      snap.forEach(doc => {
        const e = doc.data();
        total += e.price;
        resultDiv.innerHTML += `
          <div class="list-item">
            ${e.item} - ‚Çπ${e.price}
            <button onclick="openEdit('${doc.id}', '${e.date}', '${e.item}', ${e.price})">‚úèÔ∏è</button>
            <button onclick="deleteSpend('${doc.id}')">üóëÔ∏è</button>
          </div>`;
      });
      resultDiv.innerHTML += `<div class="list-item"><b>Total: ‚Çπ${total}</b></div>`;
    }

    // History
    async function loadHistory() {
      if (!currentUser) return;
      const snap = await db.collection("users").doc(currentUser.uid).collection("spends")
        .orderBy("createdAt", "desc").limit(5).get();
      const list = document.getElementById("historyList");
      if (!list) return;
      list.innerHTML = "";
      snap.forEach(doc => {
        const e = doc.data();
        list.innerHTML += `
          <div class="list-item">
            ${e.date}: ${e.item} - ‚Çπ${e.price}
            <button onclick="openEdit('${doc.id}', '${e.date}', '${e.item}', ${e.price})">‚úèÔ∏è</button>
            <button onclick="deleteSpend('${doc.id}')">üóëÔ∏è</button>
          </div>`;
      });
    }

    // Edit / Delete
    function openEdit(id, date, item, price) {
      editId = id;
      document.getElementById("edit-date").value = date;
      document.getElementById("edit-item").value = item;
      document.getElementById("edit-price").value = price;
      document.getElementById("edit-modal").style.display = "flex";
    }
    function closeEdit() { document.getElementById("edit-modal").style.display = "none"; editId = null; }
    async function saveEdit() {
      if (!currentUser || !editId) return;
      const date = document.getElementById("edit-date").value;
      const item = document.getElementById("edit-item").value;
      const price = parseFloat(document.getElementById("edit-price").value);
      await db.collection("users").doc(currentUser.uid).collection("spends").doc(editId).update({ date, item, price });
      closeEdit(); alert("Updated!"); showDaySpend(); loadHistory();
    }
    async function deleteSpend(id) {
      if (!currentUser) return;
      if (!confirm("Delete this record?")) return;
      await db.collection("users").doc(currentUser.uid).collection("spends").doc(id).delete();
      alert("Deleted!"); showDaySpend(); loadHistory();
    }

    // Export Excel with IDs
    async function downloadExcel() {
      if (!currentUser) return;
      const from = document.getElementById("fromDate").value;
      const to = document.getElementById("toDate").value;
      if (!from || !to) return alert("Select both dates");

      const snap = await db.collection("users").doc(currentUser.uid).collection("spends")
        .where("date", ">=", from).where("date", "<=", to).orderBy("date").get();

      let data = [];
      snap.forEach(doc => {
        const e = doc.data();
        data.push({ id: doc.id, date: e.date, item: e.item, price: e.price });
      });
      if (data.length === 0) return alert("No records found");

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Spends");
      XLSX.writeFile(wb, `Spends_${from}_to_${to}.xlsx`);
    }

    // Tabs
    document.querySelectorAll('.tab-btn')?.forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
      });
    });

    // Load history on start
    loadHistory();
  </script>
</body>
</html>
